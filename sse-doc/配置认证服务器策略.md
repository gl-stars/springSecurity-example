# 配置认证服务器策略

# 一、刷新令牌

如果客服端的令牌过期，可以使用刷新令牌更新令牌。这就就可以避免再次通过用户名和密码登录，重新获取令牌这些麻烦的操作了。刷新令牌只能是授权码和密码模式下有效，在认证服务器`AuthorizationServerConfig`的`authorizedGrantTypes`中配置刷新令牌的参数`refresh_token`。

![在这里插入图片描述](https://img-blog.csdnimg.cn/20200606111409893.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQxODUzNDQ3,size_16,color_FFFFFF,t_70)

更新令牌的HTTP请求参数如下：

> grant_type（必须）：表示使用的授权模式，此处的值固定为 `refresh_token`
>
> refresh_token（必须）：表示早前收到的更新令牌
>
> scope：表示申请的授权范围，不可以超出上一次申请的范围，如果省略该参数，则表示与上一次一致。

## 1.1、创建UserDetailsService实现类

创建`CustomUserDetailsService`类实现`UserDetailsService`接口，并覆写 `loadUserByUsername(String username)`这个方法。

![在这里插入图片描述](https://img-blog.csdnimg.cn/20200606135240321.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQxODUzNDQ3,size_16,color_FFFFFF,t_70)

修改安全配置类`SpringSecurityConfig`中用户名和密码的设置方式。

![在这里插入图片描述](https://img-blog.csdnimg.cn/20200606135357774.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQxODUzNDQ3,size_16,color_FFFFFF,t_70)

在认证服务器`AuthorizationServerConfig`中更改认证服务器端点配置 `configure(AuthorizationServerEndpointsConfigurer endpoints)`。

![在这里插入图片描述](https://img-blog.csdnimg.cn/20200606135557550.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQxODUzNDQ3,size_16,color_FFFFFF,t_70)

## 1.2、测试刷新令牌

重启程序，访问令牌端点都是 `/auth/oauth/token`，先获取令牌之后，就可以拿到刷新令牌，在根据刷新令牌去获取令牌。

![在这里插入图片描述](https://img-blog.csdnimg.cn/20200606140124791.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQxODUzNDQ3,size_16,color_FFFFFF,t_70)

![在这里插入图片描述](https://img-blog.csdnimg.cn/20200606140346357.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQxODUzNDQ3,size_16,color_FFFFFF,t_70)

# 二、令牌管理策略

默认情况下，令牌是通过 `randomUUID` 产生`32`位随机数的来进行填充的，而产生的令牌默认是存储在内存中。

- 内存采用`TokenStore` 接口的默认实现类 `InMemoryTokenStore`  , 开发时方便调试，适用单机版。

- `RedisTokenStore` 将令牌存储到 `Redis` 非关系型数据库中，适用于并发高的服务。
- `JdbcTokenStore` 基于 `JDBC` 将令牌存储到 关系型数据库中，可以在不同的服务器之间共享令牌。
- `JwtTokenStore （JSON Web Token）`将用户信息直接编码到令牌中，这样后端可以不用存储它，前端拿到令牌可以直接解析出用户信息。

## 2.1、Redis管理令牌

### 引入redis依赖并床架配置类

在 `sse-cloud-oauth2-base`工程中添加`Redis`依赖，版本号就不要单行了，`spring-boot-dependencies`帮我们决绝了。

```xml
 <!-- 加入redis的处理 -->
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-data-redis</artifactId>
</dependency>
```

这里的依赖我放到`sse-cloud-oauth2-base`工程下，而没有放在`sse-cloud-oauth2-auth-server`工程，因为引用了`sse-cloud-oauth2-base`工程的。

![在这里插入图片描述](https://img-blog.csdnimg.cn/20200606153725312.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQxODUzNDQ3,size_16,color_FFFFFF,t_70)

创建`TokenConfig`类指定`Redis`存储`Token`添加 `redis` 依赖后, 容器自动就会有 `RedisConnectionFactory` 实例。

![在这里插入图片描述](https://img-blog.csdnimg.cn/20200606154111501.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQxODUzNDQ3,size_16,color_FFFFFF,t_70)

### 将令牌管理策略添加到端点上

将上面令牌管理策略作用到认证服务器`AuthorizationServerConfig`端点上`configure(AuthorizationServerEndpointsConfigurer endpoints)`。

![在这里插入图片描述](https://img-blog.csdnimg.cn/20200606154420995.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQxODUzNDQ3,size_16,color_FFFFFF,t_70)

### 配置redis相关信息

这里默认是要有一个redis服务器器咯，我采用的是docker的形式。下载安装包编译的形式可以参考：[https://blog.csdn.net/qq_41853447/article/details/103201684](https://blog.csdn.net/qq_41853447/article/details/103201684)第三章redis简述及安装。<font color='blue'>注意需要开放6379端口</font>

![在这里插入图片描述](https://img-blog.csdnimg.cn/20200606155306195.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQxODUzNDQ3,size_16,color_FFFFFF,t_70)

### 测试

![在这里插入图片描述](https://img-blog.csdnimg.cn/20200606154748753.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQxODUzNDQ3,size_16,color_FFFFFF,t_70)

![在这里插入图片描述](https://img-blog.csdnimg.cn/20200606155001446.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQxODUzNDQ3,size_16,color_FFFFFF,t_70)



当前版本号：`56de860491eefb1327fd32ef52d8c71852aa151c`

## 2.2、JDBC管理令牌

官方提供的表结构地址：[https://github.com/spring-projects/spring-security-oauth/blob/master/spring-security-oauth2/src/test/resources/schema.sql](https://github.com/spring-projects/spring-security-oauth/blob/master/spring-security-oauth2/src/test/resources/schema.sql)

当前使用了 MySQL 数据库，要修改下数据类型：

- 官方提供的表结构主键类型为 `VARCHAR(256)` ，超过了`MySQL`限制的长度 `128` ，需要修改为 `VARCHAR(128)`

- 将 `LONGVARBINARY` 类型修改为 `BLOB` 类型。

将这些表`copy`下来，根据上面的要求更改后，在数据库中执行。<font color="blue">注意：表明和字段名不要随意更改，这是默认的。</font>

### 引入依赖

```xml
 <!--mybatis-plus启动器-->
<dependency>
    <groupId>com.baomidou</groupId>
    <artifactId>mybatis-plus-boot-starter</artifactId>
</dependency>
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-jdbc</artifactId>
</dependency>
<!--druid连接池-->
<dependency>
    <groupId>com.alibaba</groupId>
    <artifactId>druid</artifactId>
</dependency>
<!--mysql驱动包-->
<dependency>
    <groupId>mysql</groupId>
    <artifactId>mysql-connector-java</artifactId>
</dependency>
```

### 数据源配置application.yml

![在这里插入图片描述](https://img-blog.csdnimg.cn/20200606164901256.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQxODUzNDQ3,size_16,color_FFFFFF,t_70)

### 配置`JDBC`管理令牌

![在这里插入图片描述](https://img-blog.csdnimg.cn/20200606165157766.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQxODUzNDQ3,size_16,color_FFFFFF,t_70)

### 测试了哈

重启程序，在`postman`中获取`token`，获取到`token`之后，查看数据库中`oauth_access_token`表是否保存`token`相关信息。

![在这里插入图片描述](https://img-blog.csdnimg.cn/20200606170056761.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQxODUzNDQ3,size_16,color_FFFFFF,t_70)

<font color="blue">注意：在postman上看到的令牌和刷新令牌与数据库中保存的是不一样的，但是没有错，这个不用去关心。</font>

当前版本号：